<!doctype html>
<html>
    <head>
        <meta charset="utf8">
        <title>Perl6 Performance</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.5.0/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.6/c3.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.6/c3.min.css">
        <script>
            /** @typedef {{[category: string]: {[language: string]: number}}} ResultRecord */
            /** @typedef {{time: Date, result: ResultRecord}} ResultRecordWithTime */
            /** @type {Array<{file: string; time: number}>} */
            const resultsInfo = [];

            async function main() {
                const results = await Promise.all(
                    resultsInfo.map(
                        ({time, file}) => fetch(file).then(response => response.json()).then(
                            /** @param {ResultRecord} result */
                            result => ({time: new Date(time * 1000), result})
                        )
                    )
                );

                const categoriesHash = {};
                for (const result of results) {
                    for (const category of Object.keys(result.result)) categoriesHash[category] = true;
                }
                const categories = Object.keys(categoriesHash).sort();

                const $results = /** @type {HTMLMainElement} */(document.querySelector("#results"));
                for (const category of categories) {
                    const chart = addCategoryElement($results, category);

                    const columns = convertToCategoryData(category, results);
                    console.log(columns);
                    c3.generate({
                        bindto: chart,
                        data: {
                            x: "time",
                            columns,
                        },
                        axis: {
                            x: {
                                type: "timeseries",
                                tick: {
                                    format: "%Y-%m-%d",
                                    rotate: -30,
                                },
                            },
                            y: {
                                min: 0,
                                label: "(ms)",
                            },
                        },
                    });
                }
            }

            window.onload = main;

            /**
             * @param {HTMLElement} parent
             * @param {string} category
             */
            function addCategoryElement(parent, category) {
                const section = document.createElement("div");
                section.id = `${category}-section`;
                section.classList.add("category");
                const title = document.createElement("h2");
                title.textContent = category;
                section.appendChild(title);
                const chart = document.createElement("div");
                chart.id = `${category}-chart`;
                chart.classList.add("chart");
                section.appendChild(chart);
                parent.appendChild(section);
                return chart;
            }

            /**
             * @param {string} category
             * @param {ResultRecordWithTime[]} results
             */
            function convertToCategoryData(category, results) {
                /** @type {{[column: string]: number[]}} */
                const data = {time: []};
                for (let i = 0; i < results.length; ++i) {
                    const result = results[i];
                    data.time[i] = result.time;
                    const categoryResult = result.result[category];
                    for (const language of Object.keys(categoryResult)) {
                        if (!data[language]) data[language] = [];
                        data[language][i] = categoryResult[language];
                    }
                }
                for (const column of Object.keys(data)) {
                    for (let i = 0; i < data[column].length; ++i) {
                        if (data[column][i] == null) data[column][i] = null;
                    }
                }
                return Object.keys(data).map(column => [column, ...data[column]]);
            }
        </script>
    </head>
    <body>
        <main id="results">
        </main>
    </body>
</html>
