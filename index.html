<!doctype html>
<html>
    <head>
        <meta charset="utf8">
        <title>Perl6 Performance</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.5.0/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.6/c3.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.6/c3.min.css">
        <script>
            /** @typedef {{[category: string]: {[language: string]: number}}} ResultRecord */
            /** @typedef {{time: Date, version: {[language: string]: string}, result: ResultRecord}} ResultRecordWithTime */
            /** @type {Array<{file: string; time: number}>} */
            const resultsInfo = [{"file":"results/2018-08-05T06-21-06.json","time":1533450066},{"file":"results/2018-08-06T00-10-58.json","time":1533514258},{"file":"results/2018-08-07T00-10-31.json","time":1533600631},{"time":1533687116,"file":"results/2018-08-08T00-11-56.json"},{"file":"results/2018-08-09T00-11-35.json","time":1533773495},{"file":"results/2018-08-10T00-10-35.json","time":1533859835},{"file":"results/2018-08-11T00-10-44.json","time":1533946244},{"time":1534032679,"file":"results/2018-08-12T00-11-19.json"},{"file":"results/2018-08-13T00-11-37.json","time":1534119097},{"file":"results/2018-08-14T00-11-32.json","time":1534205492},{"file":"results/2018-08-15T00-11-19.json","time":1534291879},{"time":1534378276,"file":"results/2018-08-16T00-11-16.json"},{"file":"results/2018-08-17T00-11-25.json","time":1534464685},{"time":1534551066,"file":"results/2018-08-18T00-11-06.json"},{"time":1534637505,"file":"results/2018-08-19T00-11-45.json"},{"time":1534723866,"file":"results/2018-08-20T00-11-06.json"},{"file":"results/2018-08-21T00-12-26.json","time":1534810346},{"time":1534896711,"file":"results/2018-08-22T00-11-51.json"},{"time":1534983095,"file":"results/2018-08-23T00-11-35.json"},{"time":1535069453,"file":"results/2018-08-24T00-10-53.json"},{"time":1535155896,"file":"results/2018-08-25T00-11-36.json"},{"time":1535242294,"file":"results/2018-08-26T00-11-34.json"},{"time":1535328691,"file":"results/2018-08-27T00-11-31.json"},{"file":"results/2018-08-28T00-11-08.json","time":1535415068},{"file":"results/2018-08-29T00-10-45.json","time":1535501445},{"file":"results/2018-08-30T00-11-36.json","time":1535587896},{"time":1535674313,"file":"results/2018-08-31T00-11-53.json"},{"time":1535760644,"file":"results/2018-09-01T00-10-44.json"},{"time":1535847167,"file":"results/2018-09-02T00-12-47.json"},{"file":"results/2018-09-03T00-12-52.json","time":1535933572},{"file":"results/2018-09-04T00-15-07.json","time":1536020107},{"file":"results/2018-09-05T00-10-18.json","time":1536106218},{"time":1536192709,"file":"results/2018-09-06T00-11-49.json"},{"file":"results/2018-09-07T00-11-37.json","time":1536279097},{"file":"results/2018-09-08T00-10-42.json","time":1536365442},{"time":1536451897,"file":"results/2018-09-09T00-11-37.json"},{"file":"results/2018-09-10T00-11-16.json","time":1536538276},{"time":1536624709,"file":"results/2018-09-11T00-11-49.json"},{"file":"results/2018-09-12T00-10-53.json","time":1536711053},{"file":"results/2018-09-13T00-11-10.json","time":1536797470},{"time":1536883928,"file":"results/2018-09-14T00-12-08.json"},{"time":1536970253,"file":"results/2018-09-15T00-10-53.json"},{"file":"results/2018-09-16T00-11-51.json","time":1537056711},{"file":"results/2018-09-17T00-11-08.json","time":1537143068},{"file":"results/2018-09-18T00-12-46.json","time":1537229566},{"time":1537315884,"file":"results/2018-09-19T00-11-24.json"},{"time":1537402304,"file":"results/2018-09-20T00-11-44.json"},{"time":1537488667,"file":"results/2018-09-21T00-11-07.json"},{"file":"results/2018-09-22T00-11-37.json","time":1537575097},{"time":1537661459,"file":"results/2018-09-23T00-10-59.json"},{"file":"results/2018-09-24T00-11-40.json","time":1537747900},{"time":1537834279,"file":"results/2018-09-25T00-11-19.json"},{"file":"results/2018-09-26T00-11-18.json","time":1537920678},{"file":"results/2018-09-27T00-11-11.json","time":1538007071},{"time":1538093444,"file":"results/2018-09-28T00-10-44.json"},{"file":"results/2018-09-29T00-10-32.json","time":1538179832},{"time":1538266462,"file":"results/2018-09-30T00-14-22.json"},{"time":1538352673,"file":"results/2018-10-01T00-11-13.json"},{"file":"results/2018-10-02T00-11-17.json","time":1538439077},{"file":"results/2018-10-03T00-13-09.json","time":1538525589},{"file":"results/2018-10-04T00-11-16.json","time":1538611876},{"file":"results/2018-10-05T00-07-35.json","time":1538698055},{"file":"results/2018-10-06T00-07-49.json","time":1538784469},{"time":1538870845,"file":"results/2018-10-07T00-07-25.json"},{"file":"results/2018-10-08T00-07-56.json","time":1538957276},{"time":1539043671,"file":"results/2018-10-09T00-07-51.json"},{"file":"results/2018-10-10T00-08-05.json","time":1539130085},{"file":"results/2018-10-11T00-07-50.json","time":1539216470},{"file":"results/2018-10-12T00-08-06.json","time":1539302886},{"time":1539389254,"file":"results/2018-10-13T00-07-34.json"},{"file":"results/2018-10-14T00-07-45.json","time":1539475665},{"time":1539562032,"file":"results/2018-10-15T00-07-12.json"},{"time":1539648472,"file":"results/2018-10-16T00-07-52.json"},{"file":"results/2018-10-17T00-07-13.json","time":1539734833},{"file":"results/2018-10-18T00-07-55.json","time":1539821275},{"file":"results/2018-10-19T00-07-55.json","time":1539907675},{"file":"results/2018-10-20T00-08-33.json","time":1539994113},{"time":1540080461,"file":"results/2018-10-21T00-07-41.json"},{"time":1540166865,"file":"results/2018-10-22T00-07-45.json"},{"time":1540253255,"file":"results/2018-10-23T00-07-35.json"},{"file":"results/2018-10-24T00-08-15.json","time":1540339695},{"time":1540426053,"file":"results/2018-10-25T00-07-33.json"},{"time":1540512454,"file":"results/2018-10-26T00-07-34.json"},{"file":"results/2018-10-27T00-08-32.json","time":1540598912},{"time":1540685258,"file":"results/2018-10-28T00-07-38.json"},{"file":"results/2018-10-29T00-08-10.json","time":1540771690},{"file":"results/2018-10-30T00-08-26.json","time":1540858106},{"time":1540944478,"file":"results/2018-10-31T00-07-58.json"},{"file":"results/2018-11-01T00-07-36.json","time":1541030856},{"time":1541117273,"file":"results/2018-11-02T00-07-53.json"},{"time":1541203632,"file":"results/2018-11-03T00-07-12.json"},{"time":1541290124,"file":"results/2018-11-04T00-08-44.json"},{"file":"results/2018-11-05T00-07-30.json","time":1541376450},{"file":"results/2018-11-06T00-08-08.json","time":1541462888},{"file":"results/2018-11-07T00-08-15.json","time":1541549295}];

            async function main() {
                const results = await Promise.all(
                    resultsInfo.map(
                        ({time, file}) => fetch(file).then(response => response.json()).then(
                            /** @param {{result: ResultRecord, version: {[language: string]: string}}} json */
                            json => ({time: new Date(time * 1000), ...json})
                        )
                    )
                );

                const categoriesHash = {};
                const languagesHash = {};
                for (const result of results) {
                    for (const category of Object.keys(result.result)) {
                        categoriesHash[category] = true;
                        for (const language of Object.keys(result.result[category])) languagesHash[language] = true;
                    }
                }
                const categories = Object.keys(categoriesHash).sort();
                delete languagesHash.perl6;
                const languages = ["perl6", ...Object.keys(languagesHash).sort()];

                const $results = /** @type {HTMLMainElement} */(document.querySelector("#results"));
                for (const category of categories) {
                    const chart = addCategoryElement($results, category);

                    const json = convertToCategoryData(category, results);
                    c3.generate({
                        bindto: chart,
                        data: {
                            x: "time",
                            keys: {
                                value: ["time", ...languages],
                            },
                            json,
                            labels: true,
                        },
                        axis: {
                            x: {
                                type: "timeseries",
                                tick: {
                                    format: "%Y-%m-%d",
                                    rotate: -30,
                                },
                            },
                            y: {
                                min: 0,
                                padding: 0,
                                label: "(ms)",
                            },
                        },
                    });
                }
            }

            window.onload = main;

            /**
             * @param {HTMLElement} parent
             * @param {string} category
             */
            function addCategoryElement(parent, category) {
                const section = document.createElement("div");
                section.id = `${category}-section`;
                section.classList.add("category");
                const title = document.createElement("h2");
                title.textContent = category;
                section.appendChild(title);
                const chart = document.createElement("div");
                chart.id = `${category}-chart`;
                chart.classList.add("chart");
                section.appendChild(chart);
                parent.appendChild(section);
                return chart;
            }

            /**
             * @param {string} category
             * @param {ResultRecordWithTime[]} results
             */
            function convertToCategoryData(category, results) {
                return results.map(result => ({time: result.time, ...result.result[category]}));
            }
        </script>
    </head>
    <body>
        <h1>Perl6 Performance</h1>
        <p><a href="https://github.com/Narazaka/p6-perf">source(Github)</a></p>
        <main id="results">
        </main>
    </body>
</html>
