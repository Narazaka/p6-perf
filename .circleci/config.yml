version: 2

jobs:
  build:
    branches:
      ignore:
        - gh-pages
    docker:
      - image: base/archlinux:latest
    steps:
      - add_ssh_keys:
          fingerprints:
            - b6:ef:bc:c5:14:21:e5:97:d4:7a:a1:ce:44:78:40:26
      - checkout
      - run:
          command: pacman -Sy && pacman -S --noconfirm --needed base-devel git openssh
      - run:
          command: useradd builduser --create-home -g users
      - run:
          command: "echo 'builduser ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers"
      - run:
          command: su builduser -c 'git clone https://aur.archlinux.org/moarvm.git /tmp/moarvm'
      - run:
          command: cd /tmp/moarvm && su builduser -c 'makepkg --noconfirm --skippgpcheck -si'
      - run:
          command: cd && rm -rf /tmp/moarvm
      - run:
          command: su builduser -c 'git clone https://aur.archlinux.org/nqp.git /tmp/nqp'
      - run:
          command: cd /tmp/nqp && su builduser -c 'makepkg --noconfirm --skippgpcheck -si'
      - run:
          command: cd && rm -rf /tmp/nqp
      - run:
          command: su builduser -c 'git clone https://aur.archlinux.org/rakudo.git /tmp/rakudo'
      - run:
          command: cd /tmp/rakudo && su builduser -c 'makepkg --noconfirm --skippgpcheck -si'
      - run:
          command: cd && rm -rf /tmp/rakudo
      - run:
          command: pacman -S --noconfirm --needed nodejs luajit clang icu nim ruby perl perl-json-xs perl-file-slurp
      - run:
          command: perl run.pl
      - run:
          command: mkdir -p ~/.ssh && ssh-keyscan -H github.com >> ~/.ssh/known_hosts && git config --global user.email "p6-perf@example.com" && git config --global user.name p6-perf
      - run:
          command: git clone git@github.com:Narazaka/p6-perf -b gh-pages html
      - run:
          command: perl summarize.pl && perl archive_summarize.pl html/results && perl makehtml.pl html results index.html
      - run:
          command: cd html && git add . && git commit -m "update result at `perl -MTime::Piece -E 'say gmtime->ymd'`" && git push && cd ..
